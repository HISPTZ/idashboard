/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { ManifestService } from './manifest.service';
import { SystemInfoService } from './system-info.service';
import { throwError, of } from 'rxjs';
import { catchError, map, mergeMap, switchMap } from 'rxjs/internal/operators';
import { HTTP_CONFIG } from '../constants/http-config.constant';
import { IndexDbService } from './index-db.service';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./manifest.service";
import * as i3 from "./system-info.service";
import * as i4 from "./index-db.service";
var NgxDhis2HttpClientService = /** @class */ (function () {
    function NgxDhis2HttpClientService(httpClient, manifestService, systemInfoService, indexDbService) {
        this.httpClient = httpClient;
        this.manifestService = manifestService;
        this.systemInfoService = systemInfoService;
        this.indexDbService = indexDbService;
    }
    /**
     * @param {?} url
     * @param {?=} httpConfig
     * @return {?}
     */
    NgxDhis2HttpClientService.prototype.get = /**
     * @param {?} url
     * @param {?=} httpConfig
     * @return {?}
     */
    function (url, httpConfig) {
        var _this = this;
        var /** @type {?} */ newHttpConfig = tslib_1.__assign({}, HTTP_CONFIG, httpConfig);
        // Make a call directly from url if is external one
        if (newHttpConfig.isExternalLink) {
            return this.httpClient.get(url);
        }
        // load from index db
        if (newHttpConfig.useIndexDb) {
            return this._fetchFromIndexDb(newHttpConfig).pipe(mergeMap(function (indexDbResponse) {
                return indexDbResponse
                    ? of(indexDbResponse)
                    : _this._get(url, newHttpConfig).pipe(mergeMap(function (response) {
                        return _this._updateIndexDb(newHttpConfig, response);
                    }));
            }));
        }
        return this._get(url, newHttpConfig);
    };
    /**
     * @param {?} url
     * @param {?} data
     * @param {?=} httpConfig
     * @return {?}
     */
    NgxDhis2HttpClientService.prototype.post = /**
     * @param {?} url
     * @param {?} data
     * @param {?=} httpConfig
     * @return {?}
     */
    function (url, data, httpConfig) {
        var _this = this;
        var /** @type {?} */ newHttpConfig = tslib_1.__assign({}, HTTP_CONFIG, httpConfig);
        return this._getSanitizedRootUrl(newHttpConfig).pipe(mergeMap(function (rootUrl) {
            return _this.httpClient
                .post(rootUrl + url, data)
                .pipe(mergeMap(function (response) {
                var /** @type {?} */ dataId = response.uid;
                return newHttpConfig.useIndexDb
                    ? dataId
                        ? _this._updateIndexDb(newHttpConfig, tslib_1.__assign({}, data, { id: dataId }), 'CREATE').pipe(map(function () { return response; }))
                        : of(response)
                    : of(response);
            }))
                .pipe(catchError(_this._handleError));
        }), catchError(this._handleError));
    };
    /**
     * @param {?} url
     * @param {?} data
     * @param {?=} httpConfig
     * @return {?}
     */
    NgxDhis2HttpClientService.prototype.put = /**
     * @param {?} url
     * @param {?} data
     * @param {?=} httpConfig
     * @return {?}
     */
    function (url, data, httpConfig) {
        var _this = this;
        var /** @type {?} */ newHttpConfig = tslib_1.__assign({}, HTTP_CONFIG, httpConfig);
        return this._getSanitizedRootUrl(newHttpConfig).pipe(mergeMap(function (rootUrl) {
            return _this.httpClient.put(rootUrl + url, data).pipe(mergeMap(function (response) {
                return newHttpConfig.useIndexDb
                    ? _this._updateIndexDb(newHttpConfig, data, 'UPDATE').pipe(map(function () { return response; }))
                    : of(response);
            }), catchError(_this._handleError));
        }), catchError(this._handleError));
    };
    /**
     * @param {?} url
     * @param {?=} httpConfig
     * @return {?}
     */
    NgxDhis2HttpClientService.prototype.delete = /**
     * @param {?} url
     * @param {?=} httpConfig
     * @return {?}
     */
    function (url, httpConfig) {
        var _this = this;
        var /** @type {?} */ newHttpConfig = tslib_1.__assign({}, HTTP_CONFIG, httpConfig);
        return this._getSanitizedRootUrl(newHttpConfig).pipe(mergeMap(function (rootUrl) {
            return _this.httpClient
                .delete(rootUrl + url)
                .pipe(mergeMap(function (response) {
                return newHttpConfig.useIndexDb
                    ? _this._updateIndexDb(newHttpConfig, null, 'DELETE').pipe(map(function () { return response; }))
                    : of(response);
            }))
                .pipe(catchError(_this._handleError));
        }), catchError(this._handleError));
    };
    /**
     * @param {?} url
     * @param {?} httpConfig
     * @return {?}
     */
    NgxDhis2HttpClientService.prototype._get = /**
     * @param {?} url
     * @param {?} httpConfig
     * @return {?}
     */
    function (url, httpConfig) {
        var _this = this;
        return this._getSanitizedRootUrl(httpConfig).pipe(mergeMap(function (rootUrl) {
            return _this.httpClient.get(rootUrl + url).pipe(catchError(_this._handleError));
        }), catchError(this._handleError));
    };
    /**
     * @param {?} err
     * @return {?}
     */
    NgxDhis2HttpClientService.prototype._handleError = /**
     * @param {?} err
     * @return {?}
     */
    function (err) {
        var /** @type {?} */ error = null;
        if (err.error instanceof ErrorEvent) {
            // A client-side or network error occurred. Handle it accordingly.
            error = {
                message: err.error,
                status: err.status,
                statusText: err.statusText
            };
        }
        else {
            // The backend returned an unsuccessful response code.
            // The response body may contain clues as to what went wrong,
            error = {
                message: err.error instanceof Object
                    ? err.error.message
                    : err.error || err.message,
                status: err.status,
                statusText: err.statusText
            };
        }
        return throwError(error);
    };
    /**
     * @param {?} httpConfig
     * @return {?}
     */
    NgxDhis2HttpClientService.prototype._getSanitizedRootUrl = /**
     * @param {?} httpConfig
     * @return {?}
     */
    function (httpConfig) {
        return httpConfig.useRootUrl
            ? this.manifestService.getRootUrl()
            : this._getApiRootUrl(httpConfig.includeVersionNumber, httpConfig.preferPreviousApiVersion);
    };
    /**
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousVersion
     * @return {?}
     */
    NgxDhis2HttpClientService.prototype._getApiRootUrl = /**
     * @param {?=} includeVersionNumber
     * @param {?=} preferPreviousVersion
     * @return {?}
     */
    function (includeVersionNumber, preferPreviousVersion) {
        var _this = this;
        if (includeVersionNumber === void 0) { includeVersionNumber = false; }
        if (preferPreviousVersion === void 0) { preferPreviousVersion = false; }
        var /** @type {?} */ rootUrlPromise = this.manifestService.getRootUrl().pipe(switchMap(function (rootUrl) {
            return _this.systemInfoService.getSystemVersion().pipe(map(function (version) {
                return {
                    rootUrl: rootUrl,
                    version: version - 1 <= 25 ? version + 1 : version
                };
            }));
        }));
        return rootUrlPromise.pipe(map(function (urlInfo) {
            return urlInfo.rootUrl + "api/" + (includeVersionNumber && !preferPreviousVersion
                ? urlInfo.version + '/'
                : preferPreviousVersion
                    ? urlInfo.version
                        ? urlInfo.version - 1 + '/'
                        : ''
                    : '');
        }));
    };
    /**
     * @param {?} httpConfig
     * @param {?} requestData
     * @param {?=} action
     * @return {?}
     */
    NgxDhis2HttpClientService.prototype._updateIndexDb = /**
     * @param {?} httpConfig
     * @param {?} requestData
     * @param {?=} action
     * @return {?}
     */
    function (httpConfig, requestData, action) {
        if (action === void 0) { action = 'CREATE'; }
        var /** @type {?} */ indexDbSchema = httpConfig.indexDbConfig
            ? httpConfig.indexDbConfig.schema
            : null;
        var /** @type {?} */ arrayKey = httpConfig.indexDbConfig
            ? httpConfig.indexDbConfig.arrayKey
            : null;
        var /** @type {?} */ indexDbKey = httpConfig.indexDbConfig
            ? httpConfig.indexDbConfig.key
            : null;
        var /** @type {?} */ data = arrayKey ? requestData[arrayKey] : requestData;
        switch (action) {
            case 'CREATE':
            case 'UPDATE':
                return (action === 'CREATE'
                    ? this.indexDbService.post(indexDbSchema, data)
                    : this.indexDbService.put(indexDbSchema, data)).pipe(map(function () { return requestData; }), catchError(function (e) {
                    console.warn('Could not save data into index DB, ERROR: ' + e);
                    return of(requestData);
                }));
            case 'DELETE':
                return this.indexDbService.delete(indexDbSchema, indexDbKey).pipe(map(function () { return requestData; }), catchError(function (e) {
                    console.warn('Could not delete data from index DB, ERROR: ' + e);
                    return of(requestData);
                }));
            default:
                console.log('No action has been specified');
                return of(requestData);
        }
    };
    /**
     * @param {?} httpConfig
     * @return {?}
     */
    NgxDhis2HttpClientService.prototype._fetchFromIndexDb = /**
     * @param {?} httpConfig
     * @return {?}
     */
    function (httpConfig) {
        var /** @type {?} */ indexDbSchema = httpConfig.indexDbConfig
            ? httpConfig.indexDbConfig.schema
            : null;
        var /** @type {?} */ indexDbKey = httpConfig.indexDbConfig
            ? httpConfig.indexDbConfig.key
            : null;
        return indexDbKey
            ? this.indexDbService.findOne(indexDbSchema, indexDbKey)
            : this.indexDbService.findAll(indexDbSchema).pipe(map(function (response) {
                var /** @type {?} */ arrayKey = httpConfig.indexDbConfig
                    ? httpConfig.indexDbConfig.arrayKey
                    : null;
                return response.length > 0
                    ? arrayKey
                        ? (_a = {}, _a[arrayKey] = response, _a) : response
                    : null;
                var _a;
            }));
    };
    NgxDhis2HttpClientService.decorators = [
        { type: Injectable, args: [{ providedIn: 'root' },] },
    ];
    /** @nocollapse */
    NgxDhis2HttpClientService.ctorParameters = function () { return [
        { type: HttpClient },
        { type: ManifestService },
        { type: SystemInfoService },
        { type: IndexDbService }
    ]; };
    /** @nocollapse */ NgxDhis2HttpClientService.ngInjectableDef = i0.defineInjectable({ factory: function NgxDhis2HttpClientService_Factory() { return new NgxDhis2HttpClientService(i0.inject(i1.HttpClient), i0.inject(i2.ManifestService), i0.inject(i3.SystemInfoService), i0.inject(i4.IndexDbService)); }, token: NgxDhis2HttpClientService, providedIn: "root" });
    return NgxDhis2HttpClientService;
}());
export { NgxDhis2HttpClientService };
function NgxDhis2HttpClientService_tsickle_Closure_declarations() {
    /** @type {?} */
    NgxDhis2HttpClientService.prototype.httpClient;
    /** @type {?} */
    NgxDhis2HttpClientService.prototype.manifestService;
    /** @type {?} */
    NgxDhis2HttpClientService.prototype.systemInfoService;
    /** @type {?} */
    NgxDhis2HttpClientService.prototype.indexDbService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWRoaXMyLWh0dHAtY2xpZW50LnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AaWFwcHMvbmd4LWRoaXMyLWh0dHAtY2xpZW50LyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL25neC1kaGlzMi1odHRwLWNsaWVudC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFxQixNQUFNLHNCQUFzQixDQUFDO0FBQ3JFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNyRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQWMsVUFBVSxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsRCxPQUFPLEVBQ0wsVUFBVSxFQUNWLEdBQUcsRUFDSCxRQUFRLEVBQ1IsU0FBUyxFQUVWLE1BQU0seUJBQXlCLENBQUM7QUFFakMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ2hFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQzs7Ozs7OztJQUlsRCxtQ0FDVSxZQUNBLGlCQUNBLG1CQUNBO1FBSEEsZUFBVSxHQUFWLFVBQVU7UUFDVixvQkFBZSxHQUFmLGVBQWU7UUFDZixzQkFBaUIsR0FBakIsaUJBQWlCO1FBQ2pCLG1CQUFjLEdBQWQsY0FBYztLQUNwQjs7Ozs7O0lBRUosdUNBQUc7Ozs7O0lBQUgsVUFBSSxHQUFXLEVBQUUsVUFBdUI7UUFBeEMsaUJBd0JDO1FBdkJDLHFCQUFNLGFBQWEsd0JBQVEsV0FBVyxFQUFLLFVBQVUsQ0FBRSxDQUFDOztRQUd4RCxFQUFFLENBQUMsQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztZQUNqQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxH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VixDQUFDLENBQ0gsQ0FBQzs7O2dCQTFQVCxVQUFVLFNBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFOzs7O2dCQWZ6QixVQUFVO2dCQUNWLGVBQWU7Z0JBQ2YsaUJBQWlCO2dCQVdqQixjQUFjOzs7b0NBZHZCOztTQWlCYSx5QkFBeUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwRXJyb3JSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IE1hbmlmZXN0U2VydmljZSB9IGZyb20gJy4vbWFuaWZlc3Quc2VydmljZSc7XG5pbXBvcnQgeyBTeXN0ZW1JbmZvU2VydmljZSB9IGZyb20gJy4vc3lzdGVtLWluZm8uc2VydmljZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCB0aHJvd0Vycm9yLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgY2F0Y2hFcnJvcixcbiAgbWFwLFxuICBtZXJnZU1hcCxcbiAgc3dpdGNoTWFwLFxuICB0YXBcbn0gZnJvbSAncnhqcy9pbnRlcm5hbC9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgSHR0cENvbmZpZywgSW5kZXhEYlNjaGVtYSB9IGZyb20gJy4uL21vZGVscy9odHRwLWNvbmZpZy5tb2RlbCc7XG5pbXBvcnQgeyBIVFRQX0NPTkZJRyB9IGZyb20gJy4uL2NvbnN0YW50cy9odHRwLWNvbmZpZy5jb25zdGFudCc7XG5pbXBvcnQgeyBJbmRleERiU2VydmljZSB9IGZyb20gJy4vaW5kZXgtZGIuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXG5leHBvcnQgY2xhc3MgTmd4RGhpczJIdHRwQ2xpZW50U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgaHR0cENsaWVudDogSHR0cENsaWVudCxcbiAgICBwcml2YXRlIG1hbmlmZXN0U2VydmljZTogTWFuaWZlc3RTZXJ2aWNlLFxuICAgIHByaXZhdGUgc3lzdGVtSW5mb1NlcnZpY2U6IFN5c3RlbUluZm9TZXJ2aWNlLFxuICAgIHByaXZhdGUgaW5kZXhEYlNlcnZpY2U6IEluZGV4RGJTZXJ2aWNlXG4gICkge31cblxuICBnZXQodXJsOiBzdHJpbmcsIGh0dHBDb25maWc/OiBIdHRwQ29uZmlnKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBuZXdIdHRwQ29uZmlnID0geyAuLi5IVFRQX0NPTkZJRywgLi4uaHR0cENvbmZpZyB9O1xuXG4gICAgLy8gTWFrZSBhIGNhbGwgZGlyZWN0bHkgZnJvbSB1cmwgaWYgaXMgZXh0ZXJuYWwgb25lXG4gICAgaWYgKG5ld0h0dHBDb25maWcuaXNFeHRlcm5hbExpbmspIHtcbiAgICAgIHJldHVybiB0aGlzLmh0dHBDbGllbnQuZ2V0KHVybCk7XG4gICAgfVxuXG4gICAgLy8gbG9hZCBmcm9tIGluZGV4IGRiXG4gICAgaWYgKG5ld0h0dHBDb25maWcudXNlSW5kZXhEYikge1xuICAgICAgcmV0dXJuIHRoaXMuX2ZldGNoRnJvbUluZGV4RGIobmV3SHR0cENvbmZpZykucGlwZShcbiAgICAgICAgbWVyZ2VNYXAoKGluZGV4RGJSZXNwb25zZTogYW55KSA9PlxuICAgICAgICAgIGluZGV4RGJSZXNwb25zZVxuICAgICAgICAgICAgPyBvZihpbmRleERiUmVzcG9uc2UpXG4gICAgICAgICAgICA6IHRoaXMuX2dldCh1cmwsIG5ld0h0dHBDb25maWcpLnBpcGUoXG4gICAgICAgICAgICAgICAgbWVyZ2VNYXAoKHJlc3BvbnNlOiBhbnkpID0+XG4gICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVJbmRleERiKG5ld0h0dHBDb25maWcsIHJlc3BvbnNlKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgKVxuICAgICAgICApXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLl9nZXQodXJsLCBuZXdIdHRwQ29uZmlnKTtcbiAgfVxuXG4gIHBvc3QodXJsOiBzdHJpbmcsIGRhdGE6IGFueSwgaHR0cENvbmZpZz86IEh0dHBDb25maWcpIHtcbiAgICBjb25zdCBuZXdIdHRwQ29uZmlnID0geyAuLi5IVFRQX0NPTkZJRywgLi4uaHR0cENvbmZpZyB9O1xuXG4gICAgcmV0dXJuIHRoaXMuX2dldFNhbml0aXplZFJvb3RVcmwobmV3SHR0cENvbmZpZykucGlwZShcbiAgICAgIG1lcmdlTWFwKHJvb3RVcmwgPT5cbiAgICAgICAgdGhpcy5odHRwQ2xpZW50XG4gICAgICAgICAgLnBvc3Qocm9vdFVybCArIHVybCwgZGF0YSlcbiAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgIG1lcmdlTWFwKChyZXNwb25zZTogYW55KSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IGRhdGFJZCA9IHJlc3BvbnNlLnVpZDtcbiAgICAgICAgICAgICAgcmV0dXJuIG5ld0h0dHBDb25maWcudXNlSW5kZXhEYlxuICAgICAgICAgICAgICAgID8gZGF0YUlkXG4gICAgICAgICAgICAgICAgICA/IHRoaXMuX3VwZGF0ZUluZGV4RGIoXG4gICAgICAgICAgICAgICAgICAgICAgbmV3SHR0cENvbmZpZyxcbiAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAuLi5kYXRhLFxuICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGRhdGFJZFxuICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgJ0NSRUFURSdcbiAgICAgICAgICAgICAgICAgICAgKS5waXBlKG1hcCgoKSA9PiByZXNwb25zZSkpXG4gICAgICAgICAgICAgICAgICA6IG9mKHJlc3BvbnNlKVxuICAgICAgICAgICAgICAgIDogb2YocmVzcG9uc2UpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICApXG4gICAgICAgICAgLnBpcGUoY2F0Y2hFcnJvcih0aGlzLl9oYW5kbGVFcnJvcikpXG4gICAgICApLFxuICAgICAgY2F0Y2hFcnJvcih0aGlzLl9oYW5kbGVFcnJvcilcbiAgICApO1xuICB9XG5cbiAgcHV0KHVybDogc3RyaW5nLCBkYXRhOiBhbnksIGh0dHBDb25maWc/OiBIdHRwQ29uZmlnKSB7XG4gICAgY29uc3QgbmV3SHR0cENvbmZpZyA9IHsgLi4uSFRUUF9DT05GSUcsIC4uLmh0dHBDb25maWcgfTtcblxuICAgIHJldHVybiB0aGlzLl9nZXRTYW5pdGl6ZWRSb290VXJsKG5ld0h0dHBDb25maWcpLnBpcGUoXG4gICAgICBtZXJnZU1hcChyb290VXJsID0+XG4gICAgICAgIHRoaXMuaHR0cENsaWVudC5wdXQocm9vdFVybCArIHVybCwgZGF0YSkucGlwZShcbiAgICAgICAgICBtZXJnZU1hcCgocmVzcG9uc2U6IGFueSkgPT5cbiAgICAgICAgICAgIG5ld0h0dHBDb25maWcudXNlSW5kZXhEYlxuICAgICAgICAgICAgICA/IHRoaXMuX3VwZGF0ZUluZGV4RGIobmV3SHR0cENvbmZpZywgZGF0YSwgJ1VQREFURScpLnBpcGUoXG4gICAgICAgICAgICAgICAgICBtYXAoKCkgPT4gcmVzcG9uc2UpXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICA6IG9mKHJlc3BvbnNlKVxuICAgICAgICAgICksXG4gICAgICAgICAgY2F0Y2hFcnJvcih0aGlzLl9oYW5kbGVFcnJvcilcbiAgICAgICAgKVxuICAgICAgKSxcbiAgICAgIGNhdGNoRXJyb3IodGhpcy5faGFuZGxlRXJyb3IpXG4gICAgKTtcbiAgfVxuXG4gIGRlbGV0ZSh1cmw6IHN0cmluZywgaHR0cENvbmZpZz86IEh0dHBDb25maWcpIHtcbiAgICBjb25zdCBuZXdIdHRwQ29uZmlnID0geyAuLi5IVFRQX0NPTkZJRywgLi4uaHR0cENvbmZpZyB9O1xuXG4gICAgcmV0dXJuIHRoaXMuX2dldFNhbml0aXplZFJvb3RVcmwobmV3SHR0cENvbmZpZykucGlwZShcbiAgICAgIG1lcmdlTWFwKHJvb3RVcmwgPT5cbiAgICAgICAgdGhpcy5odHRwQ2xpZW50XG4gICAgICAgICAgLmRlbGV0ZShyb290VXJsICsgdXJsKVxuICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgbWVyZ2VNYXAoKHJlc3BvbnNlOiBhbnkpID0+XG4gICAgICAgICAgICAgIG5ld0h0dHBDb25maWcudXNlSW5kZXhEYlxuICAgICAgICAgICAgICAgID8gdGhpcy5fdXBkYXRlSW5kZXhEYihuZXdIdHRwQ29uZmlnLCBudWxsLCAnREVMRVRFJykucGlwZShcbiAgICAgICAgICAgICAgICAgICAgbWFwKCgpID0+IHJlc3BvbnNlKVxuICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIDogb2YocmVzcG9uc2UpXG4gICAgICAgICAgICApXG4gICAgICAgICAgKVxuICAgICAgICAgIC5waXBlKGNhdGNoRXJyb3IodGhpcy5faGFuZGxlRXJyb3IpKVxuICAgICAgKSxcbiAgICAgIGNhdGNoRXJyb3IodGhpcy5faGFuZGxlRXJyb3IpXG4gICAgKTtcbiAgfVxuXG4gIC8vIHByaXZhdGUgbWV0aG9kc1xuXG4gIHByaXZhdGUgX2dldCh1cmwsIGh0dHBDb25maWc6IEh0dHBDb25maWcpIHtcbiAgICByZXR1cm4gdGhpcy5fZ2V0U2FuaXRpemVkUm9vdFVybChodHRwQ29uZmlnKS5waXBlKFxuICAgICAgbWVyZ2VNYXAocm9vdFVybCA9PlxuICAgICAgICB0aGlzLmh0dHBDbGllbnQuZ2V0KHJvb3RVcmwgKyB1cmwpLnBpcGUoY2F0Y2hFcnJvcih0aGlzLl9oYW5kbGVFcnJvcikpXG4gICAgICApLFxuICAgICAgY2F0Y2hFcnJvcih0aGlzLl9oYW5kbGVFcnJvcilcbiAgICApO1xuICB9XG4gIHByaXZhdGUgX2hhbmRsZUVycm9yKGVycjogSHR0cEVycm9yUmVzcG9uc2UpIHtcbiAgICBsZXQgZXJyb3IgPSBudWxsO1xuICAgIGlmIChlcnIuZXJyb3IgaW5zdGFuY2VvZiBFcnJvckV2ZW50KSB7XG4gICAgICAvLyBBIGNsaWVudC1zaWRlIG9yIG5ldHdvcmsgZXJyb3Igb2NjdXJyZWQuIEhhbmRsZSBpdCBhY2NvcmRpbmdseS5cbiAgICAgIGVycm9yID0ge1xuICAgICAgICBtZXNzYWdlOiBlcnIuZXJyb3IsXG4gICAgICAgIHN0YXR1czogZXJyLnN0YXR1cyxcbiAgICAgICAgc3RhdHVzVGV4dDogZXJyLnN0YXR1c1RleHRcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFRoZSBiYWNrZW5kIHJldHVybmVkIGFuIHVuc3VjY2Vzc2Z1bCByZXNwb25zZSBjb2RlLlxuICAgICAgLy8gVGhlIHJlc3BvbnNlIGJvZHkgbWF5IGNvbnRhaW4gY2x1ZXMgYXMgdG8gd2hhdCB3ZW50IHdyb25nLFxuICAgICAgZXJyb3IgPSB7XG4gICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgZXJyLmVycm9yIGluc3RhbmNlb2YgT2JqZWN0XG4gICAgICAgICAgICA/IGVyci5lcnJvci5tZXNzYWdlXG4gICAgICAgICAgICA6IGVyci5lcnJvciB8fCBlcnIubWVzc2FnZSxcbiAgICAgICAgc3RhdHVzOiBlcnIuc3RhdHVzLFxuICAgICAgICBzdGF0dXNUZXh0OiBlcnIuc3RhdHVzVGV4dFxuICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0U2FuaXRpemVkUm9vdFVybChodHRwQ29uZmlnOiBIdHRwQ29uZmlnKSB7XG4gICAgcmV0dXJuIGh0dHBDb25maWcudXNlUm9vdFVybFxuICAgICAgPyB0aGlzLm1hbmlmZXN0U2VydmljZS5nZXRSb290VXJsKClcbiAgICAgIDogdGhpcy5fZ2V0QXBpUm9vdFVybChcbiAgICAgICAgICBodHRwQ29uZmlnLmluY2x1ZGVWZXJzaW9uTnVtYmVyLFxuICAgICAgICAgIGh0dHBDb25maWcucHJlZmVyUHJldmlvdXNBcGlWZXJzaW9uXG4gICAgICAgICk7XG4gIH1cblxuICBwcml2YXRlIF9nZXRBcGlSb290VXJsKFxuICAgIGluY2x1ZGVWZXJzaW9uTnVtYmVyOiBib29sZWFuID0gZmFsc2UsXG4gICAgcHJlZmVyUHJldmlvdXNWZXJzaW9uOiBib29sZWFuID0gZmFsc2VcbiAgKSB7XG4gICAgY29uc3Qgcm9vdFVybFByb21pc2UgPSB0aGlzLm1hbmlmZXN0U2VydmljZS5nZXRSb290VXJsKCkucGlwZShcbiAgICAgIHN3aXRjaE1hcChyb290VXJsID0+XG4gICAgICAgIHRoaXMuc3lzdGVtSW5mb1NlcnZpY2UuZ2V0U3lzdGVtVmVyc2lvbigpLnBpcGUoXG4gICAgICAgICAgbWFwKCh2ZXJzaW9uOiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgIHJvb3RVcmwsXG4gICAgICAgICAgICAgIHZlcnNpb246IHZlcnNpb24gLSAxIDw9IDI1ID8gdmVyc2lvbiArIDEgOiB2ZXJzaW9uXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICAgIClcbiAgICApO1xuICAgIHJldHVybiByb290VXJsUHJvbWlzZS5waXBlKFxuICAgICAgbWFwKFxuICAgICAgICAodXJsSW5mbzogeyByb290VXJsOiBzdHJpbmc7IHZlcnNpb246IG51bWJlciB9KSA9PlxuICAgICAgICAgIGAke3VybEluZm8ucm9vdFVybH1hcGkvJHtcbiAgICAgICAgICAgIGluY2x1ZGVWZXJzaW9uTnVtYmVyICYmICFwcmVmZXJQcmV2aW91c1ZlcnNpb25cbiAgICAgICAgICAgICAgPyB1cmxJbmZvLnZlcnNpb24gKyAnLydcbiAgICAgICAgICAgICAgOiBwcmVmZXJQcmV2aW91c1ZlcnNpb25cbiAgICAgICAgICAgICAgPyB1cmxJbmZvLnZlcnNpb25cbiAgICAgICAgICAgICAgICA/IHVybEluZm8udmVyc2lvbiAtIDEgKyAnLydcbiAgICAgICAgICAgICAgICA6ICcnXG4gICAgICAgICAgICAgIDogJydcbiAgICAgICAgICB9YFxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIF91cGRhdGVJbmRleERiKFxuICAgIGh0dHBDb25maWc6IEh0dHBDb25maWcsXG4gICAgcmVxdWVzdERhdGE6IGFueSxcbiAgICBhY3Rpb246IHN0cmluZyA9ICdDUkVBVEUnXG4gICkge1xuICAgIGNvbnN0IGluZGV4RGJTY2hlbWE6IEluZGV4RGJTY2hlbWEgPSBodHRwQ29uZmlnLmluZGV4RGJDb25maWdcbiAgICAgID8gaHR0cENvbmZpZy5pbmRleERiQ29uZmlnLnNjaGVtYVxuICAgICAgOiBudWxsO1xuXG4gICAgY29uc3QgYXJyYXlLZXkgPSBodHRwQ29uZmlnLmluZGV4RGJDb25maWdcbiAgICAgID8gaHR0cENvbmZpZy5pbmRleERiQ29uZmlnLmFycmF5S2V5XG4gICAgICA6IG51bGw7XG5cbiAgICBjb25zdCBpbmRleERiS2V5ID0gaHR0cENvbmZpZy5pbmRleERiQ29uZmlnXG4gICAgICA/IGh0dHBDb25maWcuaW5kZXhEYkNvbmZpZy5rZXlcbiAgICAgIDogbnVsbDtcblxuICAgIGNvbnN0IGRhdGEgPSBhcnJheUtleSA/IHJlcXVlc3REYXRhW2FycmF5S2V5XSA6IHJlcXVlc3REYXRhO1xuXG4gICAgc3dpdGNoIChhY3Rpb24pIHtcbiAgICAgIGNhc2UgJ0NSRUFURSc6XG4gICAgICBjYXNlICdVUERBVEUnOlxuICAgICAgICByZXR1cm4gKGFjdGlvbiA9PT0gJ0NSRUFURSdcbiAgICAgICAgICA/IHRoaXMuaW5kZXhEYlNlcnZpY2UucG9zdChpbmRleERiU2NoZW1hLCBkYXRhKVxuICAgICAgICAgIDogdGhpcy5pbmRleERiU2VydmljZS5wdXQoaW5kZXhEYlNjaGVtYSwgZGF0YSlcbiAgICAgICAgKS5waXBlKFxuICAgICAgICAgIG1hcCgoKSA9PiByZXF1ZXN0RGF0YSksXG4gICAgICAgICAgY2F0Y2hFcnJvcihlID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybignQ291bGQgbm90IHNhdmUgZGF0YSBpbnRvIGluZGV4IERCLCBFUlJPUjogJyArIGUpO1xuICAgICAgICAgICAgcmV0dXJuIG9mKHJlcXVlc3REYXRhKTtcbiAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgY2FzZSAnREVMRVRFJzpcbiAgICAgICAgcmV0dXJuIHRoaXMuaW5kZXhEYlNlcnZpY2UuZGVsZXRlKGluZGV4RGJTY2hlbWEsIGluZGV4RGJLZXkpLnBpcGUoXG4gICAgICAgICAgbWFwKCgpID0+IHJlcXVlc3REYXRhKSxcbiAgICAgICAgICBjYXRjaEVycm9yKGUgPT4ge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKCdDb3VsZCBub3QgZGVsZXRlIGRhdGEgZnJvbSBpbmRleCBEQiwgRVJST1I6ICcgKyBlKTtcbiAgICAgICAgICAgIHJldHVybiBvZihyZXF1ZXN0RGF0YSk7XG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGNvbnNvbGUubG9nKCdObyBhY3Rpb24gaGFzIGJlZW4gc3BlY2lmaWVkJyk7XG4gICAgICAgIHJldHVybiBvZihyZXF1ZXN0RGF0YSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfZmV0Y2hGcm9tSW5kZXhEYihodHRwQ29uZmlnOiBIdHRwQ29uZmlnKSB7XG4gICAgY29uc3QgaW5kZXhEYlNjaGVtYTogSW5kZXhEYlNjaGVtYSA9IGh0dHBDb25maWcuaW5kZXhEYkNvbmZpZ1xuICAgICAgPyBodHRwQ29uZmlnLmluZGV4RGJDb25maWcuc2NoZW1hXG4gICAgICA6IG51bGw7XG5cbiAgICBjb25zdCBpbmRleERiS2V5ID0gaHR0cENvbmZpZy5pbmRleERiQ29uZmlnXG4gICAgICA/IGh0dHBDb25maWcuaW5kZXhEYkNvbmZpZy5rZXlcbiAgICAgIDogbnVsbDtcblxuICAgIHJldHVybiBpbmRleERiS2V5XG4gICAgICA/IHRoaXMuaW5kZXhEYlNlcnZpY2UuZmluZE9uZShpbmRleERiU2NoZW1hLCBpbmRleERiS2V5KVxuICAgICAgOiB0aGlzLmluZGV4RGJTZXJ2aWNlLmZpbmRBbGwoaW5kZXhEYlNjaGVtYSkucGlwZShcbiAgICAgICAgICBtYXAocmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgY29uc3QgYXJyYXlLZXkgPSBodHRwQ29uZmlnLmluZGV4RGJDb25maWdcbiAgICAgICAgICAgICAgPyBodHRwQ29uZmlnLmluZGV4RGJDb25maWcuYXJyYXlLZXlcbiAgICAgICAgICAgICAgOiBudWxsO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmxlbmd0aCA+IDBcbiAgICAgICAgICAgICAgPyBhcnJheUtleVxuICAgICAgICAgICAgICAgID8geyBbYXJyYXlLZXldOiByZXNwb25zZSB9XG4gICAgICAgICAgICAgICAgOiByZXNwb25zZVxuICAgICAgICAgICAgICA6IG51bGw7XG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgfVxufVxuIl19