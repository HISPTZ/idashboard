/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { Observable } from 'rxjs';
import * as _ from 'lodash';
import { switchMap, mergeMap } from 'rxjs/operators';
import * as i0 from "@angular/core";
var IndexDbService = /** @class */ (function () {
    function IndexDbService() {
        this._indexedDB = indexedDB;
        this._dbName = 'db'; // by default
    }
    /**
     * @param {?} dbName
     * @return {?}
     */
    IndexDbService.prototype.setName = /**
     * @param {?} dbName
     * @return {?}
     */
    function (dbName) {
        if (dbName) {
            this._dbName = dbName;
        }
    };
    /**
     * Function to update existing data in the db
     */
    /**
     * Function to update existing data in the db
     * @param {?} schema
     * @param {?} data
     * @return {?}
     */
    IndexDbService.prototype.put = /**
     * Function to update existing data in the db
     * @param {?} schema
     * @param {?} data
     * @return {?}
     */
    function (schema, data) {
        var _this = this;
        return Observable.create(function (observer) {
            _this.create(schema)
                .pipe(switchMap(function () { return _this.open(); }))
                .subscribe(function (db) {
                var /** @type {?} */ transaction = db.transaction(schema.name, 'readwrite');
                var /** @type {?} */ store = transaction.objectStore(schema.name);
                if (_.isArray(data)) {
                    _.each(data, function (dataItem) {
                        store.put(dataItem);
                    });
                }
                else {
                    store.put(data);
                }
                transaction.oncomplete = function () {
                    observer.next(data);
                    db.close();
                    observer.complete();
                };
                db.onerror = function (errorEvent) {
                    db.close();
                    observer.error(errorEvent.target.errorCode);
                };
            });
        });
    };
    /**
     * Function to add new data in the db
     */
    /**
     * Function to add new data in the db
     * @param {?} schema
     * @param {?} data
     * @return {?}
     */
    IndexDbService.prototype.post = /**
     * Function to add new data in the db
     * @param {?} schema
     * @param {?} data
     * @return {?}
     */
    function (schema, data) {
        var _this = this;
        return Observable.create(function (observer) {
            _this.create(schema)
                .pipe(mergeMap(function () { return _this.open(); }))
                .subscribe(function (db) {
                var /** @type {?} */ transaction = db.transaction(schema.name, 'readwrite');
                var /** @type {?} */ store = transaction.objectStore(schema.name);
                // Check if data is array or an object
                if (_.isArray(data)) {
                    _.each(data, function (dataItem) {
                        store.add(dataItem);
                    });
                }
                else {
                    store.add(data);
                }
                transaction.oncomplete = function () {
                    observer.next(data);
                    db.close();
                    observer.complete();
                };
                db.onerror = function () {
                    observer.next(data);
                    db.close();
                    observer.complete();
                };
            });
        });
    };
    /**
     * Function to get value for a particular key from the table
     */
    /**
     * Function to get value for a particular key from the table
     * @param {?} schema
     * @param {?} key
     * @return {?}
     */
    IndexDbService.prototype.findOne = /**
     * Function to get value for a particular key from the table
     * @param {?} schema
     * @param {?} key
     * @return {?}
     */
    function (schema, key) {
        var _this = this;
        return new Observable(function (observer) {
            _this.create(schema)
                .pipe(mergeMap(function () { return _this.open(); }))
                .subscribe(function (db) {
                var /** @type {?} */ transaction = db.transaction(schema.name, 'readwrite');
                var /** @type {?} */ store = transaction.objectStore(schema.name);
                var /** @type {?} */ request = store.get(key);
                request.onsuccess = function (successEvent) {
                    observer.next(successEvent.target.result);
                    db.close();
                    observer.complete();
                };
                db.onerror = function (event) {
                    console.log(event.target.errorCode);
                    db.close();
                    observer.error(event.target.errorCode);
                };
            });
        });
    };
    /**
     * Function to find all values for a particular table in the db
     */
    /**
     * Function to find all values for a particular table in the db
     * @param {?} schema
     * @return {?}
     */
    IndexDbService.prototype.findAll = /**
     * Function to find all values for a particular table in the db
     * @param {?} schema
     * @return {?}
     */
    function (schema) {
        var _this = this;
        return Observable.create(function (observer) {
            _this.create(schema)
                .pipe(switchMap(function () { return _this.open(); }))
                .subscribe(function (db) {
                var /** @type {?} */ transaction = db.transaction(schema.name, 'readwrite');
                var /** @type {?} */ store = transaction.objectStore(schema.name);
                var /** @type {?} */ storeIndex = store.index(schema.keyPath);
                var /** @type {?} */ request = storeIndex.openCursor();
                var /** @type {?} */ results = [];
                request.onsuccess = function (successEvent) {
                    var /** @type {?} */ cursor = successEvent.target.result;
                    if (cursor) {
                        results = tslib_1.__spread(results, [cursor.value]);
                        cursor.continue();
                    }
                    else {
                        observer.next(results);
                        db.close();
                        observer.complete();
                    }
                };
                db.onerror = function (event) {
                    db.close();
                    observer.error(event.target.errorCode);
                };
            });
        });
    };
    /**
     * Delete data from the db
     */
    /**
     * Delete data from the db
     * @param {?} schema
     * @param {?} key
     * @return {?}
     */
    IndexDbService.prototype.delete = /**
     * Delete data from the db
     * @param {?} schema
     * @param {?} key
     * @return {?}
     */
    function (schema, key) {
        var _this = this;
        return Observable.create(function (observer) {
            _this.open().subscribe(function (db) {
                if (!db.objectStoreNames.contains(schema.name)) {
                    var /** @type {?} */ transaction = db.transaction(schema.name, 'readwrite');
                    var /** @type {?} */ store_1 = transaction.objectStore(schema.name);
                    if (_.isArray(key)) {
                        _.each(key, function (keyItem) {
                            store_1.delete(keyItem);
                        });
                    }
                    else {
                        store_1.delete(key);
                    }
                    transaction.oncomplete = function () {
                        observer.next(key);
                        db.close();
                        observer.complete();
                    };
                    db.onerror = function (errorEvent) {
                        db.close();
                        observer.error(errorEvent.target.errorCode);
                    };
                }
            });
        });
    };
    /**
     * Create a schema/table
     */
    /**
     * Create a schema/table
     * @param {?} schema
     * @return {?}
     */
    IndexDbService.prototype.create = /**
     * Create a schema/table
     * @param {?} schema
     * @return {?}
     */
    function (schema) {
        var _this = this;
        return Observable.create(function (observer) {
            _this.open().subscribe(function (requestResult) {
                if (!requestResult.objectStoreNames.contains(schema.name)) {
                    /**
                               * Close database to allow opening with new version
                               */
                    requestResult.close();
                    /**
                     * Set a new connection with new version to allows creating schema
                     */
                    var /** @type {?} */ request = _this._indexedDB.open(_this._dbName, requestResult.version + 1);
                    request.onupgradeneeded = function (event) {
                        var /** @type {?} */ db = event.target.result;
                        if (!db.objectStoreNames.contains(schema.name)) {
                            /**
                             * Create corresponding schema
                             */
                            var /** @type {?} */ store_2 = db.createObjectStore(schema.name, {
                                keyPath: schema.keyPath
                            });
                            store_2.createIndex(schema.keyPath, schema.keyPath, {
                                unique: true
                            });
                            /**
                                           * Create indexes for schema if supplied
                                           */
                            if (schema.indexes) {
                                _.each(schema.indexes, function (schemaIndex) {
                                    store_2.createIndex(schemaIndex, schemaIndex);
                                });
                            }
                            /**
                                           * Add data if supplied
                                           */
                            if (schema.data) {
                                _.each(schema.data, function (dataItem) {
                                    store_2.put(dataItem);
                                });
                            }
                        }
                        observer.next('done');
                        observer.complete();
                    };
                    request.onerror = function (errorEvent) {
                        observer.error(errorEvent.target.errorCode);
                    };
                    request.onsuccess = function (successEvent) {
                        successEvent.target.result.close();
                        observer.next('done');
                        observer.complete();
                    };
                }
                else {
                    observer.next('done');
                    observer.complete();
                }
            });
        });
    };
    /**
     * Delete the whole database
     */
    /**
     * Delete the whole database
     * @return {?}
     */
    IndexDbService.prototype.clear = /**
     * Delete the whole database
     * @return {?}
     */
    function () {
        var _this = this;
        return Observable.create(function (observer) {
            var /** @type {?} */ request = _this._indexedDB.deleteDatabase(_this._dbName);
            request.onsuccess = function () {
                observer.next('done');
                observer.complete();
            };
            request.onerror = function (errorEvent) {
                observer.error(errorEvent.target.errorCode);
            };
            request.onblocked = function (blockEvent) {
                observer.error(blockEvent.target.errorCode);
            };
        });
    };
    /**
     * @return {?}
     */
    IndexDbService.prototype.open = /**
     * @return {?}
     */
    function () {
        var _this = this;
        return Observable.create(function (observer) {
            var /** @type {?} */ request = _this._indexedDB.open(_this._dbName);
            request.onsuccess = function (successEvent) {
                observer.next(successEvent.target.result);
                observer.complete();
            };
            request.onerror = function (errorEvent) {
                return observer.error(errorEvent.target.errorCode);
            };
        });
    };
    IndexDbService.decorators = [
        { type: Injectable, args: [{ providedIn: 'root' },] },
    ];
    /** @nocollapse */
    IndexDbService.ctorParameters = function () { return []; };
    /** @nocollapse */ IndexDbService.ngInjectableDef = i0.defineInjectable({ factory: function IndexDbService_Factory() { return new IndexDbService(); }, token: IndexDbService, providedIn: "root" });
    return IndexDbService;
}());
export { IndexDbService };
function IndexDbService_tsickle_Closure_declarations() {
    /** @type {?} */
    IndexDbService.prototype._indexedDB;
    /** @type {?} */
    IndexDbService.prototype._dbName;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXgtZGIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BpYXBwcy9uZ3gtZGhpczItaHR0cC1jbGllbnQvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvaW5kZXgtZGIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsQyxPQUFPLEtBQUssQ0FBQyxNQUFNLFFBQVEsQ0FBQztBQUM1QixPQUFPLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBTyxNQUFNLGdCQUFnQixDQUFDOzs7SUFPeEQ7UUFDRSxJQUFJLENBQUMsVUFBVSxHQUFHLFNBQVMsQ0FBQztRQUM1QixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztLQUNyQjs7Ozs7SUFFRCxnQ0FBTzs7OztJQUFQLFVBQVEsTUFBYztRQUNwQixFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ1gsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7U0FDdkI7S0FDRjtJQUVEOztPQUVHOzs7Ozs7O0lBQ0gsNEJBQUc7Ozs7OztJQUFILFVBQUksTUFBVyxFQUFFLElBQVM7UUFBMUIsaUJBMkJDO1FBMUJDLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLFVBQUMsUUFBYTtZQUNyQyxLQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQztpQkFDaEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFNLE9BQUEsS0FBSSxDQUFDLElBQUksRUFBRSxFQUFYLENBQVcsQ0FBQyxDQUFDO2lCQUNsQyxTQUFTLENBQUMsVUFBQyxFQUFPO2dCQUNqQixxQkFBTSxXQUFXLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLFdBQVcsQ0FBQyxDQUFDO2dCQUM3RCxxQkFBTSxLQUFLLEdBQUcs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b250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHN3aXRjaE1hcCwgbWVyZ2VNYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBJbmRleERiU2VydmljZSB7XG4gIHByaXZhdGUgX2luZGV4ZWREQjogYW55O1xuICBwcml2YXRlIF9kYk5hbWU6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLl9pbmRleGVkREIgPSBpbmRleGVkREI7XG4gICAgdGhpcy5fZGJOYW1lID0gJ2RiJzsgLy8gYnkgZGVmYXVsdFxuICB9XG5cbiAgc2V0TmFtZShkYk5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChkYk5hbWUpIHtcbiAgICAgIHRoaXMuX2RiTmFtZSA9IGRiTmFtZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRnVuY3Rpb24gdG8gdXBkYXRlIGV4aXN0aW5nIGRhdGEgaW4gdGhlIGRiXG4gICAqL1xuICBwdXQoc2NoZW1hOiBhbnksIGRhdGE6IGFueSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcjogYW55KSA9PiB7XG4gICAgICB0aGlzLmNyZWF0ZShzY2hlbWEpXG4gICAgICAgIC5waXBlKHN3aXRjaE1hcCgoKSA9PiB0aGlzLm9wZW4oKSkpXG4gICAgICAgIC5zdWJzY3JpYmUoKGRiOiBhbnkpID0+IHtcbiAgICAgICAgICBjb25zdCB0cmFuc2FjdGlvbiA9IGRiLnRyYW5zYWN0aW9uKHNjaGVtYS5uYW1lLCAncmVhZHdyaXRlJyk7XG4gICAgICAgICAgY29uc3Qgc3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZShzY2hlbWEubmFtZSk7XG5cbiAgICAgICAgICBpZiAoXy5pc0FycmF5KGRhdGEpKSB7XG4gICAgICAgICAgICBfLmVhY2goZGF0YSwgZGF0YUl0ZW0gPT4ge1xuICAgICAgICAgICAgICBzdG9yZS5wdXQoZGF0YUl0ZW0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN0b3JlLnB1dChkYXRhKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB0cmFuc2FjdGlvbi5vbmNvbXBsZXRlID0gKCkgPT4ge1xuICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChkYXRhKTtcbiAgICAgICAgICAgIGRiLmNsb3NlKCk7XG4gICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgIH07XG4gICAgICAgICAgZGIub25lcnJvciA9IChlcnJvckV2ZW50OiBhbnkpID0+IHtcbiAgICAgICAgICAgIGRiLmNsb3NlKCk7XG4gICAgICAgICAgICBvYnNlcnZlci5lcnJvcihlcnJvckV2ZW50LnRhcmdldC5lcnJvckNvZGUpO1xuICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEZ1bmN0aW9uIHRvIGFkZCBuZXcgZGF0YSBpbiB0aGUgZGJcbiAgICovXG4gIHBvc3Qoc2NoZW1hOiBhbnksIGRhdGE6IGFueSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcjogYW55KSA9PiB7XG4gICAgICB0aGlzLmNyZWF0ZShzY2hlbWEpXG4gICAgICAgIC5waXBlKG1lcmdlTWFwKCgpID0+IHRoaXMub3BlbigpKSlcbiAgICAgICAgLnN1YnNjcmliZSgoZGI6IGFueSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gZGIudHJhbnNhY3Rpb24oc2NoZW1hLm5hbWUsICdyZWFkd3JpdGUnKTtcbiAgICAgICAgICBjb25zdCBzdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKHNjaGVtYS5uYW1lKTtcblxuICAgICAgICAgIC8vIENoZWNrIGlmIGRhdGEgaXMgYXJyYXkgb3IgYW4gb2JqZWN0XG4gICAgICAgICAgaWYgKF8uaXNBcnJheShkYXRhKSkge1xuICAgICAgICAgICAgXy5lYWNoKGRhdGEsIGRhdGFJdGVtID0+IHtcbiAgICAgICAgICAgICAgc3RvcmUuYWRkKGRhdGFJdGVtKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdG9yZS5hZGQoZGF0YSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdHJhbnNhY3Rpb24ub25jb21wbGV0ZSA9ICgpID0+IHtcbiAgICAgICAgICAgIG9ic2VydmVyLm5leHQoZGF0YSk7XG4gICAgICAgICAgICBkYi5jbG9zZSgpO1xuICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICB9O1xuICAgICAgICAgIGRiLm9uZXJyb3IgPSAoKSA9PiB7XG4gICAgICAgICAgICBvYnNlcnZlci5uZXh0KGRhdGEpO1xuICAgICAgICAgICAgZGIuY2xvc2UoKTtcbiAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgfTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRnVuY3Rpb24gdG8gZ2V0IHZhbHVlIGZvciBhIHBhcnRpY3VsYXIga2V5IGZyb20gdGhlIHRhYmxlXG4gICAqL1xuICBmaW5kT25lKHNjaGVtYTogYW55LCBrZXk6IHN0cmluZyk6IE9ic2VydmFibGU8YW55W10+IHtcbiAgICByZXR1cm4gbmV3IE9ic2VydmFibGUoKG9ic2VydmVyOiBhbnkpID0+IHtcbiAgICAgIHRoaXMuY3JlYXRlKHNjaGVtYSlcbiAgICAgICAgLnBpcGUobWVyZ2VNYXAoKCkgPT4gdGhpcy5vcGVuKCkpKVxuICAgICAgICAuc3Vic2NyaWJlKChkYjogYW55KSA9PiB7XG4gICAgICAgICAgY29uc3QgdHJhbnNhY3Rpb24gPSBkYi50cmFuc2FjdGlvbihzY2hlbWEubmFtZSwgJ3JlYWR3cml0ZScpO1xuICAgICAgICAgIGNvbnN0IHN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUoc2NoZW1hLm5hbWUpO1xuICAgICAgICAgIGNvbnN0IHJlcXVlc3QgPSBzdG9yZS5nZXQoa2V5KTtcbiAgICAgICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9IHN1Y2Nlc3NFdmVudCA9PiB7XG4gICAgICAgICAgICBvYnNlcnZlci5uZXh0KHN1Y2Nlc3NFdmVudC50YXJnZXQucmVzdWx0KTtcbiAgICAgICAgICAgIGRiLmNsb3NlKCk7XG4gICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgIH07XG4gICAgICAgICAgZGIub25lcnJvciA9IChldmVudDogYW55KSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhldmVudC50YXJnZXQuZXJyb3JDb2RlKTtcbiAgICAgICAgICAgIGRiLmNsb3NlKCk7XG4gICAgICAgICAgICBvYnNlcnZlci5lcnJvcihldmVudC50YXJnZXQuZXJyb3JDb2RlKTtcbiAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGdW5jdGlvbiB0byBmaW5kIGFsbCB2YWx1ZXMgZm9yIGEgcGFydGljdWxhciB0YWJsZSBpbiB0aGUgZGJcbiAgICovXG4gIGZpbmRBbGwoc2NoZW1hOiBhbnkpOiBPYnNlcnZhYmxlPGFueVtdPiB7XG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcjogYW55KSA9PiB7XG4gICAgICB0aGlzLmNyZWF0ZShzY2hlbWEpXG4gICAgICAgIC5waXBlKHN3aXRjaE1hcCgoKSA9PiB0aGlzLm9wZW4oKSkpXG4gICAgICAgIC5zdWJzY3JpYmUoKGRiOiBhbnkpID0+IHtcbiAgICAgICAgICBjb25zdCB0cmFuc2FjdGlvbiA9IGRiLnRyYW5zYWN0aW9uKHNjaGVtYS5uYW1lLCAncmVhZHdyaXRlJyk7XG4gICAgICAgICAgY29uc3Qgc3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZShzY2hlbWEubmFtZSk7XG4gICAgICAgICAgY29uc3Qgc3RvcmVJbmRleCA9IHN0b3JlLmluZGV4KHNjaGVtYS5rZXlQYXRoKTtcbiAgICAgICAgICBjb25zdCByZXF1ZXN0ID0gc3RvcmVJbmRleC5vcGVuQ3Vyc29yKCk7XG4gICAgICAgICAgbGV0IHJlc3VsdHM6IGFueVtdID0gW107XG5cbiAgICAgICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9IHN1Y2Nlc3NFdmVudCA9PiB7XG4gICAgICAgICAgICBjb25zdCBjdXJzb3IgPSBzdWNjZXNzRXZlbnQudGFyZ2V0LnJlc3VsdDtcbiAgICAgICAgICAgIGlmIChjdXJzb3IpIHtcbiAgICAgICAgICAgICAgcmVzdWx0cyA9IFsuLi5yZXN1bHRzLCBjdXJzb3IudmFsdWVdO1xuICAgICAgICAgICAgICBjdXJzb3IuY29udGludWUoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIG9ic2VydmVyLm5leHQocmVzdWx0cyk7XG4gICAgICAgICAgICAgIGRiLmNsb3NlKCk7XG4gICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfTtcbiAgICAgICAgICBkYi5vbmVycm9yID0gKGV2ZW50OiBhbnkpID0+IHtcbiAgICAgICAgICAgIGRiLmNsb3NlKCk7XG4gICAgICAgICAgICBvYnNlcnZlci5lcnJvcihldmVudC50YXJnZXQuZXJyb3JDb2RlKTtcbiAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWxldGUgZGF0YSBmcm9tIHRoZSBkYlxuICAgKi9cbiAgZGVsZXRlKHNjaGVtYTogYW55LCBrZXk6IHN0cmluZyB8IHN0cmluZ1tdKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUoKG9ic2VydmVyOiBhbnkpID0+IHtcbiAgICAgIHRoaXMub3BlbigpLnN1YnNjcmliZSgoZGI6IGFueSkgPT4ge1xuICAgICAgICBpZiAoIWRiLm9iamVjdFN0b3JlTmFtZXMuY29udGFpbnMoc2NoZW1hLm5hbWUpKSB7XG4gICAgICAgICAgY29uc3QgdHJhbnNhY3Rpb24gPSBkYi50cmFuc2FjdGlvbihzY2hlbWEubmFtZSwgJ3JlYWR3cml0ZScpO1xuICAgICAgICAgIGNvbnN0IHN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUoc2NoZW1hLm5hbWUpO1xuXG4gICAgICAgICAgaWYgKF8uaXNBcnJheShrZXkpKSB7XG4gICAgICAgICAgICBfLmVhY2goa2V5LCBrZXlJdGVtID0+IHtcbiAgICAgICAgICAgICAgc3RvcmUuZGVsZXRlKGtleUl0ZW0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN0b3JlLmRlbGV0ZShrZXkpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHRyYW5zYWN0aW9uLm9uY29tcGxldGUgPSAoKSA9PiB7XG4gICAgICAgICAgICBvYnNlcnZlci5uZXh0KGtleSk7XG4gICAgICAgICAgICBkYi5jbG9zZSgpO1xuICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICB9O1xuICAgICAgICAgIGRiLm9uZXJyb3IgPSAoZXJyb3JFdmVudDogYW55KSA9PiB7XG4gICAgICAgICAgICBkYi5jbG9zZSgpO1xuICAgICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyb3JFdmVudC50YXJnZXQuZXJyb3JDb2RlKTtcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBzY2hlbWEvdGFibGVcbiAgICovXG4gIGNyZWF0ZShzY2hlbWE6IGFueSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcjogYW55KSA9PiB7XG4gICAgICB0aGlzLm9wZW4oKS5zdWJzY3JpYmUoKHJlcXVlc3RSZXN1bHQ6IGFueSkgPT4ge1xuICAgICAgICBpZiAoIXJlcXVlc3RSZXN1bHQub2JqZWN0U3RvcmVOYW1lcy5jb250YWlucyhzY2hlbWEubmFtZSkpIHtcbiAgICAgICAgICAvKipcbiAgICAgICAgICAgKiBDbG9zZSBkYXRhYmFzZSB0byBhbGxvdyBvcGVuaW5nIHdpdGggbmV3IHZlcnNpb25cbiAgICAgICAgICAgKi9cbiAgICAgICAgICByZXF1ZXN0UmVzdWx0LmNsb3NlKCk7XG5cbiAgICAgICAgICAvKipcbiAgICAgICAgICAgKiBTZXQgYSBuZXcgY29ubmVjdGlvbiB3aXRoIG5ldyB2ZXJzaW9uIHRvIGFsbG93cyBjcmVhdGluZyBzY2hlbWFcbiAgICAgICAgICAgKi9cbiAgICAgICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5faW5kZXhlZERCLm9wZW4oXG4gICAgICAgICAgICB0aGlzLl9kYk5hbWUsXG4gICAgICAgICAgICByZXF1ZXN0UmVzdWx0LnZlcnNpb24gKyAxXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIHJlcXVlc3Qub251cGdyYWRlbmVlZGVkID0gZXZlbnQgPT4ge1xuICAgICAgICAgICAgY29uc3QgZGIgPSBldmVudC50YXJnZXQucmVzdWx0O1xuICAgICAgICAgICAgaWYgKCFkYi5vYmplY3RTdG9yZU5hbWVzLmNvbnRhaW5zKHNjaGVtYS5uYW1lKSkge1xuICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICogQ3JlYXRlIGNvcnJlc3BvbmRpbmcgc2NoZW1hXG4gICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICBjb25zdCBzdG9yZSA9IGRiLmNyZWF0ZU9iamVjdFN0b3JlKHNjaGVtYS5uYW1lLCB7XG4gICAgICAgICAgICAgICAga2V5UGF0aDogc2NoZW1hLmtleVBhdGhcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIHN0b3JlLmNyZWF0ZUluZGV4KHNjaGVtYS5rZXlQYXRoLCBzY2hlbWEua2V5UGF0aCwge1xuICAgICAgICAgICAgICAgIHVuaXF1ZTogdHJ1ZVxuICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICogQ3JlYXRlIGluZGV4ZXMgZm9yIHNjaGVtYSBpZiBzdXBwbGllZFxuICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgaWYgKHNjaGVtYS5pbmRleGVzKSB7XG4gICAgICAgICAgICAgICAgXy5lYWNoKHNjaGVtYS5pbmRleGVzLCAoc2NoZW1hSW5kZXg6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgc3RvcmUuY3JlYXRlSW5kZXgoc2NoZW1hSW5kZXgsIHNjaGVtYUluZGV4KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICAgKiBBZGQgZGF0YSBpZiBzdXBwbGllZFxuICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgaWYgKHNjaGVtYS5kYXRhKSB7XG4gICAgICAgICAgICAgICAgXy5lYWNoKHNjaGVtYS5kYXRhLCAoZGF0YUl0ZW06IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgc3RvcmUucHV0KGRhdGFJdGVtKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBvYnNlcnZlci5uZXh0KCdkb25lJyk7XG4gICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgIH07XG5cbiAgICAgICAgICByZXF1ZXN0Lm9uZXJyb3IgPSBlcnJvckV2ZW50ID0+IHtcbiAgICAgICAgICAgIG9ic2VydmVyLmVycm9yKGVycm9yRXZlbnQudGFyZ2V0LmVycm9yQ29kZSk7XG4gICAgICAgICAgfTtcblxuICAgICAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gc3VjY2Vzc0V2ZW50ID0+IHtcbiAgICAgICAgICAgIHN1Y2Nlc3NFdmVudC50YXJnZXQucmVzdWx0LmNsb3NlKCk7XG4gICAgICAgICAgICBvYnNlcnZlci5uZXh0KCdkb25lJyk7XG4gICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb2JzZXJ2ZXIubmV4dCgnZG9uZScpO1xuICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSB0aGUgd2hvbGUgZGF0YWJhc2VcbiAgICovXG4gIGNsZWFyKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcjogYW55KSA9PiB7XG4gICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5faW5kZXhlZERCLmRlbGV0ZURhdGFiYXNlKHRoaXMuX2RiTmFtZSk7XG5cbiAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gKCkgPT4ge1xuICAgICAgICBvYnNlcnZlci5uZXh0KCdkb25lJyk7XG4gICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICB9O1xuICAgICAgcmVxdWVzdC5vbmVycm9yID0gZXJyb3JFdmVudCA9PiB7XG4gICAgICAgIG9ic2VydmVyLmVycm9yKGVycm9yRXZlbnQudGFyZ2V0LmVycm9yQ29kZSk7XG4gICAgICB9O1xuICAgICAgcmVxdWVzdC5vbmJsb2NrZWQgPSBibG9ja0V2ZW50ID0+IHtcbiAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoYmxvY2tFdmVudC50YXJnZXQuZXJyb3JDb2RlKTtcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIG9wZW4oKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUoKG9ic2VydmVyOiBhbnkpID0+IHtcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9pbmRleGVkREIub3Blbih0aGlzLl9kYk5hbWUpO1xuXG4gICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9IHN1Y2Nlc3NFdmVudCA9PiB7XG4gICAgICAgIG9ic2VydmVyLm5leHQoc3VjY2Vzc0V2ZW50LnRhcmdldC5yZXN1bHQpO1xuICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgfTtcbiAgICAgIHJlcXVlc3Qub25lcnJvciA9IGVycm9yRXZlbnQgPT5cbiAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyb3JFdmVudC50YXJnZXQuZXJyb3JDb2RlKTtcbiAgICB9KTtcbiAgfVxufVxuIl19