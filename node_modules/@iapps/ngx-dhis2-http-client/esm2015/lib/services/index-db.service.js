/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Injectable } from '@angular/core';
import { Observable } from 'rxjs';
import * as _ from 'lodash';
import { switchMap, mergeMap } from 'rxjs/operators';
import * as i0 from "@angular/core";
export class IndexDbService {
    constructor() {
        this._indexedDB = indexedDB;
        this._dbName = 'db'; // by default
    }
    /**
     * @param {?} dbName
     * @return {?}
     */
    setName(dbName) {
        if (dbName) {
            this._dbName = dbName;
        }
    }
    /**
     * Function to update existing data in the db
     * @param {?} schema
     * @param {?} data
     * @return {?}
     */
    put(schema, data) {
        return Observable.create((observer) => {
            this.create(schema)
                .pipe(switchMap(() => this.open()))
                .subscribe((db) => {
                const /** @type {?} */ transaction = db.transaction(schema.name, 'readwrite');
                const /** @type {?} */ store = transaction.objectStore(schema.name);
                if (_.isArray(data)) {
                    _.each(data, dataItem => {
                        store.put(dataItem);
                    });
                }
                else {
                    store.put(data);
                }
                transaction.oncomplete = () => {
                    observer.next(data);
                    db.close();
                    observer.complete();
                };
                db.onerror = (errorEvent) => {
                    db.close();
                    observer.error(errorEvent.target.errorCode);
                };
            });
        });
    }
    /**
     * Function to add new data in the db
     * @param {?} schema
     * @param {?} data
     * @return {?}
     */
    post(schema, data) {
        return Observable.create((observer) => {
            this.create(schema)
                .pipe(mergeMap(() => this.open()))
                .subscribe((db) => {
                const /** @type {?} */ transaction = db.transaction(schema.name, 'readwrite');
                const /** @type {?} */ store = transaction.objectStore(schema.name);
                // Check if data is array or an object
                if (_.isArray(data)) {
                    _.each(data, dataItem => {
                        store.add(dataItem);
                    });
                }
                else {
                    store.add(data);
                }
                transaction.oncomplete = () => {
                    observer.next(data);
                    db.close();
                    observer.complete();
                };
                db.onerror = () => {
                    observer.next(data);
                    db.close();
                    observer.complete();
                };
            });
        });
    }
    /**
     * Function to get value for a particular key from the table
     * @param {?} schema
     * @param {?} key
     * @return {?}
     */
    findOne(schema, key) {
        return new Observable((observer) => {
            this.create(schema)
                .pipe(mergeMap(() => this.open()))
                .subscribe((db) => {
                const /** @type {?} */ transaction = db.transaction(schema.name, 'readwrite');
                const /** @type {?} */ store = transaction.objectStore(schema.name);
                const /** @type {?} */ request = store.get(key);
                request.onsuccess = successEvent => {
                    observer.next(successEvent.target.result);
                    db.close();
                    observer.complete();
                };
                db.onerror = (event) => {
                    console.log(event.target.errorCode);
                    db.close();
                    observer.error(event.target.errorCode);
                };
            });
        });
    }
    /**
     * Function to find all values for a particular table in the db
     * @param {?} schema
     * @return {?}
     */
    findAll(schema) {
        return Observable.create((observer) => {
            this.create(schema)
                .pipe(switchMap(() => this.open()))
                .subscribe((db) => {
                const /** @type {?} */ transaction = db.transaction(schema.name, 'readwrite');
                const /** @type {?} */ store = transaction.objectStore(schema.name);
                const /** @type {?} */ storeIndex = store.index(schema.keyPath);
                const /** @type {?} */ request = storeIndex.openCursor();
                let /** @type {?} */ results = [];
                request.onsuccess = successEvent => {
                    const /** @type {?} */ cursor = successEvent.target.result;
                    if (cursor) {
                        results = [...results, cursor.value];
                        cursor.continue();
                    }
                    else {
                        observer.next(results);
                        db.close();
                        observer.complete();
                    }
                };
                db.onerror = (event) => {
                    db.close();
                    observer.error(event.target.errorCode);
                };
            });
        });
    }
    /**
     * Delete data from the db
     * @param {?} schema
     * @param {?} key
     * @return {?}
     */
    delete(schema, key) {
        return Observable.create((observer) => {
            this.open().subscribe((db) => {
                if (!db.objectStoreNames.contains(schema.name)) {
                    const /** @type {?} */ transaction = db.transaction(schema.name, 'readwrite');
                    const /** @type {?} */ store = transaction.objectStore(schema.name);
                    if (_.isArray(key)) {
                        _.each(key, keyItem => {
                            store.delete(keyItem);
                        });
                    }
                    else {
                        store.delete(key);
                    }
                    transaction.oncomplete = () => {
                        observer.next(key);
                        db.close();
                        observer.complete();
                    };
                    db.onerror = (errorEvent) => {
                        db.close();
                        observer.error(errorEvent.target.errorCode);
                    };
                }
            });
        });
    }
    /**
     * Create a schema/table
     * @param {?} schema
     * @return {?}
     */
    create(schema) {
        return Observable.create((observer) => {
            this.open().subscribe((requestResult) => {
                if (!requestResult.objectStoreNames.contains(schema.name)) {
                    /**
                               * Close database to allow opening with new version
                               */
                    requestResult.close();
                    /**
                     * Set a new connection with new version to allows creating schema
                     */
                    const /** @type {?} */ request = this._indexedDB.open(this._dbName, requestResult.version + 1);
                    request.onupgradeneeded = event => {
                        const /** @type {?} */ db = event.target.result;
                        if (!db.objectStoreNames.contains(schema.name)) {
                            /**
                             * Create corresponding schema
                             */
                            const /** @type {?} */ store = db.createObjectStore(schema.name, {
                                keyPath: schema.keyPath
                            });
                            store.createIndex(schema.keyPath, schema.keyPath, {
                                unique: true
                            });
                            /**
                                           * Create indexes for schema if supplied
                                           */
                            if (schema.indexes) {
                                _.each(schema.indexes, (schemaIndex) => {
                                    store.createIndex(schemaIndex, schemaIndex);
                                });
                            }
                            /**
                                           * Add data if supplied
                                           */
                            if (schema.data) {
                                _.each(schema.data, (dataItem) => {
                                    store.put(dataItem);
                                });
                            }
                        }
                        observer.next('done');
                        observer.complete();
                    };
                    request.onerror = errorEvent => {
                        observer.error(errorEvent.target.errorCode);
                    };
                    request.onsuccess = successEvent => {
                        successEvent.target.result.close();
                        observer.next('done');
                        observer.complete();
                    };
                }
                else {
                    observer.next('done');
                    observer.complete();
                }
            });
        });
    }
    /**
     * Delete the whole database
     * @return {?}
     */
    clear() {
        return Observable.create((observer) => {
            const /** @type {?} */ request = this._indexedDB.deleteDatabase(this._dbName);
            request.onsuccess = () => {
                observer.next('done');
                observer.complete();
            };
            request.onerror = errorEvent => {
                observer.error(errorEvent.target.errorCode);
            };
            request.onblocked = blockEvent => {
                observer.error(blockEvent.target.errorCode);
            };
        });
    }
    /**
     * @return {?}
     */
    open() {
        return Observable.create((observer) => {
            const /** @type {?} */ request = this._indexedDB.open(this._dbName);
            request.onsuccess = successEvent => {
                observer.next(successEvent.target.result);
                observer.complete();
            };
            request.onerror = errorEvent => observer.error(errorEvent.target.errorCode);
        });
    }
}
IndexDbService.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] },
];
/** @nocollapse */
IndexDbService.ctorParameters = () => [];
/** @nocollapse */ IndexDbService.ngInjectableDef = i0.defineInjectable({ factory: function IndexDbService_Factory() { return new IndexDbService(); }, token: IndexDbService, providedIn: "root" });
function IndexDbService_tsickle_Closure_declarations() {
    /** @type {?} */
    IndexDbService.prototype._indexedDB;
    /** @type {?} */
    IndexDbService.prototype._dbName;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXgtZGIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BpYXBwcy9uZ3gtZGhpczItaHR0cC1jbGllbnQvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvaW5kZXgtZGIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2xDLE9BQU8sS0FBSyxDQUFDLE1BQU0sUUFBUSxDQUFDO0FBQzVCLE9BQU8sRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFPLE1BQU0sZ0JBQWdCLENBQUM7O0FBRzFELE1BQU07SUFJSjtRQUNFLElBQUksQ0FBQyxVQUFVLEdBQUcsU0FBUyxDQUFDO1FBQzVCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO0tBQ3JCOzs7OztJQUVELE9BQU8sQ0FBQyxNQUFjO1FBQ3BCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDWCxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztTQUN2QjtLQUNGOzs7Ozs7O0lBS0QsR0FBRyxDQUFDLE1BQVcsRUFBRSxJQUFTO1FBQ3hCLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsUUFBYSxFQUFFLEVBQUU7WUFDekMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7aUJBQ2hCLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7aUJBQ2xDLFNBQVMsQ0FBQyxDQUFDLEVBQU8sRUFBRSxFQUFFO2dCQUNyQix1QkFBTSxXQUFXLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLFdBQVcsQ0FBQyxDQUFDO2dCQUM3RCx1QkFBTSxLQUFLLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQyxN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RUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHN3aXRjaE1hcCwgbWVyZ2VNYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBJbmRleERiU2VydmljZSB7XG4gIHByaXZhdGUgX2luZGV4ZWREQjogYW55O1xuICBwcml2YXRlIF9kYk5hbWU6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLl9pbmRleGVkREIgPSBpbmRleGVkREI7XG4gICAgdGhpcy5fZGJOYW1lID0gJ2RiJzsgLy8gYnkgZGVmYXVsdFxuICB9XG5cbiAgc2V0TmFtZShkYk5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChkYk5hbWUpIHtcbiAgICAgIHRoaXMuX2RiTmFtZSA9IGRiTmFtZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRnVuY3Rpb24gdG8gdXBkYXRlIGV4aXN0aW5nIGRhdGEgaW4gdGhlIGRiXG4gICAqL1xuICBwdXQoc2NoZW1hOiBhbnksIGRhdGE6IGFueSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcjogYW55KSA9PiB7XG4gICAgICB0aGlzLmNyZWF0ZShzY2hlbWEpXG4gICAgICAgIC5waXBlKHN3aXRjaE1hcCgoKSA9PiB0aGlzLm9wZW4oKSkpXG4gICAgICAgIC5zdWJzY3JpYmUoKGRiOiBhbnkpID0+IHtcbiAgICAgICAgICBjb25zdCB0cmFuc2FjdGlvbiA9IGRiLnRyYW5zYWN0aW9uKHNjaGVtYS5uYW1lLCAncmVhZHdyaXRlJyk7XG4gICAgICAgICAgY29uc3Qgc3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZShzY2hlbWEubmFtZSk7XG5cbiAgICAgICAgICBpZiAoXy5pc0FycmF5KGRhdGEpKSB7XG4gICAgICAgICAgICBfLmVhY2goZGF0YSwgZGF0YUl0ZW0gPT4ge1xuICAgICAgICAgICAgICBzdG9yZS5wdXQoZGF0YUl0ZW0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN0b3JlLnB1dChkYXRhKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB0cmFuc2FjdGlvbi5vbmNvbXBsZXRlID0gKCkgPT4ge1xuICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChkYXRhKTtcbiAgICAgICAgICAgIGRiLmNsb3NlKCk7XG4gICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgIH07XG4gICAgICAgICAgZGIub25lcnJvciA9IChlcnJvckV2ZW50OiBhbnkpID0+IHtcbiAgICAgICAgICAgIGRiLmNsb3NlKCk7XG4gICAgICAgICAgICBvYnNlcnZlci5lcnJvcihlcnJvckV2ZW50LnRhcmdldC5lcnJvckNvZGUpO1xuICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEZ1bmN0aW9uIHRvIGFkZCBuZXcgZGF0YSBpbiB0aGUgZGJcbiAgICovXG4gIHBvc3Qoc2NoZW1hOiBhbnksIGRhdGE6IGFueSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcjogYW55KSA9PiB7XG4gICAgICB0aGlzLmNyZWF0ZShzY2hlbWEpXG4gICAgICAgIC5waXBlKG1lcmdlTWFwKCgpID0+IHRoaXMub3BlbigpKSlcbiAgICAgICAgLnN1YnNjcmliZSgoZGI6IGFueSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gZGIudHJhbnNhY3Rpb24oc2NoZW1hLm5hbWUsICdyZWFkd3JpdGUnKTtcbiAgICAgICAgICBjb25zdCBzdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKHNjaGVtYS5uYW1lKTtcblxuICAgICAgICAgIC8vIENoZWNrIGlmIGRhdGEgaXMgYXJyYXkgb3IgYW4gb2JqZWN0XG4gICAgICAgICAgaWYgKF8uaXNBcnJheShkYXRhKSkge1xuICAgICAgICAgICAgXy5lYWNoKGRhdGEsIGRhdGFJdGVtID0+IHtcbiAgICAgICAgICAgICAgc3RvcmUuYWRkKGRhdGFJdGVtKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdG9yZS5hZGQoZGF0YSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdHJhbnNhY3Rpb24ub25jb21wbGV0ZSA9ICgpID0+IHtcbiAgICAgICAgICAgIG9ic2VydmVyLm5leHQoZGF0YSk7XG4gICAgICAgICAgICBkYi5jbG9zZSgpO1xuICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICB9O1xuICAgICAgICAgIGRiLm9uZXJyb3IgPSAoKSA9PiB7XG4gICAgICAgICAgICBvYnNlcnZlci5uZXh0KGRhdGEpO1xuICAgICAgICAgICAgZGIuY2xvc2UoKTtcbiAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgfTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRnVuY3Rpb24gdG8gZ2V0IHZhbHVlIGZvciBhIHBhcnRpY3VsYXIga2V5IGZyb20gdGhlIHRhYmxlXG4gICAqL1xuICBmaW5kT25lKHNjaGVtYTogYW55LCBrZXk6IHN0cmluZyk6IE9ic2VydmFibGU8YW55W10+IHtcbiAgICByZXR1cm4gbmV3IE9ic2VydmFibGUoKG9ic2VydmVyOiBhbnkpID0+IHtcbiAgICAgIHRoaXMuY3JlYXRlKHNjaGVtYSlcbiAgICAgICAgLnBpcGUobWVyZ2VNYXAoKCkgPT4gdGhpcy5vcGVuKCkpKVxuICAgICAgICAuc3Vic2NyaWJlKChkYjogYW55KSA9PiB7XG4gICAgICAgICAgY29uc3QgdHJhbnNhY3Rpb24gPSBkYi50cmFuc2FjdGlvbihzY2hlbWEubmFtZSwgJ3JlYWR3cml0ZScpO1xuICAgICAgICAgIGNvbnN0IHN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUoc2NoZW1hLm5hbWUpO1xuICAgICAgICAgIGNvbnN0IHJlcXVlc3QgPSBzdG9yZS5nZXQoa2V5KTtcbiAgICAgICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9IHN1Y2Nlc3NFdmVudCA9PiB7XG4gICAgICAgICAgICBvYnNlcnZlci5uZXh0KHN1Y2Nlc3NFdmVudC50YXJnZXQucmVzdWx0KTtcbiAgICAgICAgICAgIGRiLmNsb3NlKCk7XG4gICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgIH07XG4gICAgICAgICAgZGIub25lcnJvciA9IChldmVudDogYW55KSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhldmVudC50YXJnZXQuZXJyb3JDb2RlKTtcbiAgICAgICAgICAgIGRiLmNsb3NlKCk7XG4gICAgICAgICAgICBvYnNlcnZlci5lcnJvcihldmVudC50YXJnZXQuZXJyb3JDb2RlKTtcbiAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGdW5jdGlvbiB0byBmaW5kIGFsbCB2YWx1ZXMgZm9yIGEgcGFydGljdWxhciB0YWJsZSBpbiB0aGUgZGJcbiAgICovXG4gIGZpbmRBbGwoc2NoZW1hOiBhbnkpOiBPYnNlcnZhYmxlPGFueVtdPiB7XG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcjogYW55KSA9PiB7XG4gICAgICB0aGlzLmNyZWF0ZShzY2hlbWEpXG4gICAgICAgIC5waXBlKHN3aXRjaE1hcCgoKSA9PiB0aGlzLm9wZW4oKSkpXG4gICAgICAgIC5zdWJzY3JpYmUoKGRiOiBhbnkpID0+IHtcbiAgICAgICAgICBjb25zdCB0cmFuc2FjdGlvbiA9IGRiLnRyYW5zYWN0aW9uKHNjaGVtYS5uYW1lLCAncmVhZHdyaXRlJyk7XG4gICAgICAgICAgY29uc3Qgc3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZShzY2hlbWEubmFtZSk7XG4gICAgICAgICAgY29uc3Qgc3RvcmVJbmRleCA9IHN0b3JlLmluZGV4KHNjaGVtYS5rZXlQYXRoKTtcbiAgICAgICAgICBjb25zdCByZXF1ZXN0ID0gc3RvcmVJbmRleC5vcGVuQ3Vyc29yKCk7XG4gICAgICAgICAgbGV0IHJlc3VsdHM6IGFueVtdID0gW107XG5cbiAgICAgICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9IHN1Y2Nlc3NFdmVudCA9PiB7XG4gICAgICAgICAgICBjb25zdCBjdXJzb3IgPSBzdWNjZXNzRXZlbnQudGFyZ2V0LnJlc3VsdDtcbiAgICAgICAgICAgIGlmIChjdXJzb3IpIHtcbiAgICAgICAgICAgICAgcmVzdWx0cyA9IFsuLi5yZXN1bHRzLCBjdXJzb3IudmFsdWVdO1xuICAgICAgICAgICAgICBjdXJzb3IuY29udGludWUoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIG9ic2VydmVyLm5leHQocmVzdWx0cyk7XG4gICAgICAgICAgICAgIGRiLmNsb3NlKCk7XG4gICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfTtcbiAgICAgICAgICBkYi5vbmVycm9yID0gKGV2ZW50OiBhbnkpID0+IHtcbiAgICAgICAgICAgIGRiLmNsb3NlKCk7XG4gICAgICAgICAgICBvYnNlcnZlci5lcnJvcihldmVudC50YXJnZXQuZXJyb3JDb2RlKTtcbiAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWxldGUgZGF0YSBmcm9tIHRoZSBkYlxuICAgKi9cbiAgZGVsZXRlKHNjaGVtYTogYW55LCBrZXk6IHN0cmluZyB8IHN0cmluZ1tdKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUoKG9ic2VydmVyOiBhbnkpID0+IHtcbiAgICAgIHRoaXMub3BlbigpLnN1YnNjcmliZSgoZGI6IGFueSkgPT4ge1xuICAgICAgICBpZiAoIWRiLm9iamVjdFN0b3JlTmFtZXMuY29udGFpbnMoc2NoZW1hLm5hbWUpKSB7XG4gICAgICAgICAgY29uc3QgdHJhbnNhY3Rpb24gPSBkYi50cmFuc2FjdGlvbihzY2hlbWEubmFtZSwgJ3JlYWR3cml0ZScpO1xuICAgICAgICAgIGNvbnN0IHN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUoc2NoZW1hLm5hbWUpO1xuXG4gICAgICAgICAgaWYgKF8uaXNBcnJheShrZXkpKSB7XG4gICAgICAgICAgICBfLmVhY2goa2V5LCBrZXlJdGVtID0+IHtcbiAgICAgICAgICAgICAgc3RvcmUuZGVsZXRlKGtleUl0ZW0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN0b3JlLmRlbGV0ZShrZXkpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHRyYW5zYWN0aW9uLm9uY29tcGxldGUgPSAoKSA9PiB7XG4gICAgICAgICAgICBvYnNlcnZlci5uZXh0KGtleSk7XG4gICAgICAgICAgICBkYi5jbG9zZSgpO1xuICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICB9O1xuICAgICAgICAgIGRiLm9uZXJyb3IgPSAoZXJyb3JFdmVudDogYW55KSA9PiB7XG4gICAgICAgICAgICBkYi5jbG9zZSgpO1xuICAgICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyb3JFdmVudC50YXJnZXQuZXJyb3JDb2RlKTtcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBzY2hlbWEvdGFibGVcbiAgICovXG4gIGNyZWF0ZShzY2hlbWE6IGFueSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcjogYW55KSA9PiB7XG4gICAgICB0aGlzLm9wZW4oKS5zdWJzY3JpYmUoKHJlcXVlc3RSZXN1bHQ6IGFueSkgPT4ge1xuICAgICAgICBpZiAoIXJlcXVlc3RSZXN1bHQub2JqZWN0U3RvcmVOYW1lcy5jb250YWlucyhzY2hlbWEubmFtZSkpIHtcbiAgICAgICAgICAvKipcbiAgICAgICAgICAgKiBDbG9zZSBkYXRhYmFzZSB0byBhbGxvdyBvcGVuaW5nIHdpdGggbmV3IHZlcnNpb25cbiAgICAgICAgICAgKi9cbiAgICAgICAgICByZXF1ZXN0UmVzdWx0LmNsb3NlKCk7XG5cbiAgICAgICAgICAvKipcbiAgICAgICAgICAgKiBTZXQgYSBuZXcgY29ubmVjdGlvbiB3aXRoIG5ldyB2ZXJzaW9uIHRvIGFsbG93cyBjcmVhdGluZyBzY2hlbWFcbiAgICAgICAgICAgKi9cbiAgICAgICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5faW5kZXhlZERCLm9wZW4oXG4gICAgICAgICAgICB0aGlzLl9kYk5hbWUsXG4gICAgICAgICAgICByZXF1ZXN0UmVzdWx0LnZlcnNpb24gKyAxXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIHJlcXVlc3Qub251cGdyYWRlbmVlZGVkID0gZXZlbnQgPT4ge1xuICAgICAgICAgICAgY29uc3QgZGIgPSBldmVudC50YXJnZXQucmVzdWx0O1xuICAgICAgICAgICAgaWYgKCFkYi5vYmplY3RTdG9yZU5hbWVzLmNvbnRhaW5zKHNjaGVtYS5uYW1lKSkge1xuICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICogQ3JlYXRlIGNvcnJlc3BvbmRpbmcgc2NoZW1hXG4gICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICBjb25zdCBzdG9yZSA9IGRiLmNyZWF0ZU9iamVjdFN0b3JlKHNjaGVtYS5uYW1lLCB7XG4gICAgICAgICAgICAgICAga2V5UGF0aDogc2NoZW1hLmtleVBhdGhcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIHN0b3JlLmNyZWF0ZUluZGV4KHNjaGVtYS5rZXlQYXRoLCBzY2hlbWEua2V5UGF0aCwge1xuICAgICAgICAgICAgICAgIHVuaXF1ZTogdHJ1ZVxuICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICogQ3JlYXRlIGluZGV4ZXMgZm9yIHNjaGVtYSBpZiBzdXBwbGllZFxuICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgaWYgKHNjaGVtYS5pbmRleGVzKSB7XG4gICAgICAgICAgICAgICAgXy5lYWNoKHNjaGVtYS5pbmRleGVzLCAoc2NoZW1hSW5kZXg6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgc3RvcmUuY3JlYXRlSW5kZXgoc2NoZW1hSW5kZXgsIHNjaGVtYUluZGV4KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICAgKiBBZGQgZGF0YSBpZiBzdXBwbGllZFxuICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgaWYgKHNjaGVtYS5kYXRhKSB7XG4gICAgICAgICAgICAgICAgXy5lYWNoKHNjaGVtYS5kYXRhLCAoZGF0YUl0ZW06IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgc3RvcmUucHV0KGRhdGFJdGVtKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBvYnNlcnZlci5uZXh0KCdkb25lJyk7XG4gICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgIH07XG5cbiAgICAgICAgICByZXF1ZXN0Lm9uZXJyb3IgPSBlcnJvckV2ZW50ID0+IHtcbiAgICAgICAgICAgIG9ic2VydmVyLmVycm9yKGVycm9yRXZlbnQudGFyZ2V0LmVycm9yQ29kZSk7XG4gICAgICAgICAgfTtcblxuICAgICAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gc3VjY2Vzc0V2ZW50ID0+IHtcbiAgICAgICAgICAgIHN1Y2Nlc3NFdmVudC50YXJnZXQucmVzdWx0LmNsb3NlKCk7XG4gICAgICAgICAgICBvYnNlcnZlci5uZXh0KCdkb25lJyk7XG4gICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb2JzZXJ2ZXIubmV4dCgnZG9uZScpO1xuICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSB0aGUgd2hvbGUgZGF0YWJhc2VcbiAgICovXG4gIGNsZWFyKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcjogYW55KSA9PiB7XG4gICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5faW5kZXhlZERCLmRlbGV0ZURhdGFiYXNlKHRoaXMuX2RiTmFtZSk7XG5cbiAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gKCkgPT4ge1xuICAgICAgICBvYnNlcnZlci5uZXh0KCdkb25lJyk7XG4gICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICB9O1xuICAgICAgcmVxdWVzdC5vbmVycm9yID0gZXJyb3JFdmVudCA9PiB7XG4gICAgICAgIG9ic2VydmVyLmVycm9yKGVycm9yRXZlbnQudGFyZ2V0LmVycm9yQ29kZSk7XG4gICAgICB9O1xuICAgICAgcmVxdWVzdC5vbmJsb2NrZWQgPSBibG9ja0V2ZW50ID0+IHtcbiAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoYmxvY2tFdmVudC50YXJnZXQuZXJyb3JDb2RlKTtcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIG9wZW4oKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUoKG9ic2VydmVyOiBhbnkpID0+IHtcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9pbmRleGVkREIub3Blbih0aGlzLl9kYk5hbWUpO1xuXG4gICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9IHN1Y2Nlc3NFdmVudCA9PiB7XG4gICAgICAgIG9ic2VydmVyLm5leHQoc3VjY2Vzc0V2ZW50LnRhcmdldC5yZXN1bHQpO1xuICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgfTtcbiAgICAgIHJlcXVlc3Qub25lcnJvciA9IGVycm9yRXZlbnQgPT5cbiAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyb3JFdmVudC50YXJnZXQuZXJyb3JDb2RlKTtcbiAgICB9KTtcbiAgfVxufVxuIl19