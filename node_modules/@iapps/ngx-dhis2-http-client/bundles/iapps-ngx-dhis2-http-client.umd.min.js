!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common/http"),require("rxjs"),require("rxjs/internal/operators"),require("lodash"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("@iapps/ngx-dhis2-http-client",["exports","@angular/core","@angular/common/http","rxjs","rxjs/internal/operators","lodash","rxjs/operators"],t):t((e.iapps=e.iapps||{},e.iapps["ngx-dhis2-http-client"]={}),e.ng.core,e.ng.common.http,e.rxjs,e.rxjs["internal/operators"],null,e.rxjs.operators)}(this,function(e,t,r,c,s,a,u){"use strict";var n=function(){function e(e){this.httpClient=e,this._defaultRootUrl="../../../",this._manifestLoaded=!1}return e.prototype.getManifest=function(){var t=this;return this._manifestLoaded?c.of(this._manifest):this.httpClient.get("manifest.webapp").pipe(s.catchError(function(){return console.warn("Manifest file could not be loaded, default options have been used instead"),c.of(null)}),s.tap(function(e){t._manifest=e,t._manifestLoaded=!0}))},e.prototype.getRootUrl=function(){var t=this;return this.getManifest().pipe(s.map(function(e){return e&&e.activities&&e.activities.dhis&&e.activities.dhis.href?e.activities.dhis.href:t._defaultRootUrl}))},e.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:r.HttpClient}]},e.ngInjectableDef=t.defineInjectable({factory:function(){return new e(t.inject(r.HttpClient))},token:e,providedIn:"root"}),e}(),i=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e};function p(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),a=[];try{for(;(void 0===t||0<t--)&&!(n=i.next()).done;)a.push(n.value)}catch(c){o={error:c}}finally{try{n&&!n.done&&(r=i["return"])&&r.call(i)}finally{if(o)throw o.error}}return a}var o=function(){function e(e,t){this.manifestService=e,this.httpClient=t,this._systemInfoLoaded=!1}return e.prototype.getSystemInfo=function(){var t=this;return this._systemInfoLoaded?c.of(this._systemInfo):this.manifestService.getRootUrl().pipe(s.switchMap(function(e){return c.forkJoin(t.httpClient.get(e+"api/system/info"),t.httpClient.get(e+"api/systemSettings")).pipe(s.map(function(e){return i({},e[0],e[1])}),s.tap(function(e){t._systemInfo=e,t._systemInfoLoaded=!0}))}))},e.prototype.getSystemVersion=function(){return this.getSystemInfo().pipe(s.map(function(e){if(!e)return 0;var t=e.version?e.version.split("."):[];return parseInt(t[1],10)||0}))},e.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:n},{type:r.HttpClient}]},e.ngInjectableDef=t.defineInjectable({factory:function(){return new e(t.inject(n),t.inject(r.HttpClient))},token:e,providedIn:"root"}),e}(),f={includeVersionNumber:!1,preferPreviousApiVersion:!1,useRootUrl:!1,useIndexDb:!1,isExternalLink:!1},d=function(){function e(){this._indexedDB=indexedDB,this._dbName="db"}return e.prototype.setName=function(e){e&&(this._dbName=e)},e.prototype.put=function(o,i){var e=this;return c.Observable.create(function(n){e.create(o).pipe(u.switchMap(function(){return e.open()})).subscribe(function(t){var e=t.transaction(o.name,"readwrite"),r=e.objectStore(o.name);a.isArray(i)?a.each(i,function(e){r.put(e)}):r.put(i),e.oncomplete=function(){n.next(i),t.close(),n.complete()},t.onerror=function(e){t.close(),n.error(e.target.errorCode)}})})},e.prototype.post=function(o,i){var e=this;return c.Observable.create(function(n){e.create(o).pipe(u.mergeMap(function(){return e.open()})).subscribe(function(e){var t=e.transaction(o.name,"readwrite"),r=t.objectStore(o.name);a.isArray(i)?a.each(i,function(e){r.add(e)}):r.add(i),t.oncomplete=function(){n.next(i),e.close(),n.complete()},e.onerror=function(){n.next(i),e.close(),n.complete()}})})},e.prototype.findOne=function(e,n){var t=this;return new c.Observable(function(r){t.create(e).pipe(u.mergeMap(function(){return t.open()})).subscribe(function(t){t.transaction(e.name,"readwrite").objectStore(e.name).get(n).onsuccess=function(e){r.next(e.target.result),t.close(),r.complete()},t.onerror=function(e){console.log(e.target.errorCode),t.close(),r.error(e.target.errorCode)}})})},e.prototype.findAll=function(t){var e=this;return c.Observable.create(function(o){e.create(t).pipe(u.switchMap(function(){return e.open()})).subscribe(function(r){var e=r.transaction(t.name,"readwrite").objectStore(t.name).index(t.keyPath).openCursor(),n=[];e.onsuccess=function(e){var t=e.target.result;t?(n=function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(p(arguments[t]));return e}(n,[t.value]),t["continue"]()):(o.next(n),r.close(),o.complete())},r.onerror=function(e){r.close(),o.error(e.target.errorCode)}})})},e.prototype["delete"]=function(o,i){var e=this;return c.Observable.create(function(n){e.open().subscribe(function(t){if(!t.objectStoreNames.contains(o.name)){var e=t.transaction(o.name,"readwrite"),r=e.objectStore(o.name);a.isArray(i)?a.each(i,function(e){r["delete"](e)}):r["delete"](i),e.oncomplete=function(){n.next(i),t.close(),n.complete()},t.onerror=function(e){t.close(),n.error(e.target.errorCode)}}})})},e.prototype.create=function(o){var r=this;return c.Observable.create(function(n){r.open().subscribe(function(e){if(e.objectStoreNames.contains(o.name))n.next("done"),n.complete();else{e.close();var t=r._indexedDB.open(r._dbName,e.version+1);t.onupgradeneeded=function(e){var t=e.target.result;if(!t.objectStoreNames.contains(o.name)){var r=t.createObjectStore(o.name,{keyPath:o.keyPath});r.createIndex(o.keyPath,o.keyPath,{unique:!0}),o.indexes&&a.each(o.indexes,function(e){r.createIndex(e,e)}),o.data&&a.each(o.data,function(e){r.put(e)})}n.next("done"),n.complete()},t.onerror=function(e){n.error(e.target.errorCode)},t.onsuccess=function(e){e.target.result.close(),n.next("done"),n.complete()}}})})},e.prototype.clear=function(){var r=this;return c.Observable.create(function(t){var e=r._indexedDB.deleteDatabase(r._dbName);e.onsuccess=function(){t.next("done"),t.complete()},e.onerror=function(e){t.error(e.target.errorCode)},e.onblocked=function(e){t.error(e.target.errorCode)}})},e.prototype.open=function(){var r=this;return c.Observable.create(function(t){var e=r._indexedDB.open(r._dbName);e.onsuccess=function(e){t.next(e.target.result),t.complete()},e.onerror=function(e){return t.error(e.target.errorCode)}})},e.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[]},e.ngInjectableDef=t.defineInjectable({factory:function(){return new e},token:e,providedIn:"root"}),e}(),l=function(){function e(e,t,r,n){this.httpClient=e,this.manifestService=t,this.systemInfoService=r,this.indexDbService=n}return e.prototype.get=function(t,e){var r=this,n=i({},f,e);return n.isExternalLink?this.httpClient.get(t):n.useIndexDb?this._fetchFromIndexDb(n).pipe(s.mergeMap(function(e){return e?c.of(e):r._get(t,n).pipe(s.mergeMap(function(e){return r._updateIndexDb(n,e)}))})):this._get(t,n)},e.prototype.post=function(t,r,e){var n=this,o=i({},f,e);return this._getSanitizedRootUrl(o).pipe(s.mergeMap(function(e){return n.httpClient.post(e+t,r).pipe(s.mergeMap(function(e){var t=e.uid;return o.useIndexDb&&t?n._updateIndexDb(o,i({},r,{id:t}),"CREATE").pipe(s.map(function(){return e})):c.of(e)})).pipe(s.catchError(n._handleError))}),s.catchError(this._handleError))},e.prototype.put=function(t,r,e){var n=this,o=i({},f,e);return this._getSanitizedRootUrl(o).pipe(s.mergeMap(function(e){return n.httpClient.put(e+t,r).pipe(s.mergeMap(function(e){return o.useIndexDb?n._updateIndexDb(o,r,"UPDATE").pipe(s.map(function(){return e})):c.of(e)}),s.catchError(n._handleError))}),s.catchError(this._handleError))},e.prototype["delete"]=function(t,e){var r=this,n=i({},f,e);return this._getSanitizedRootUrl(n).pipe(s.mergeMap(function(e){return r.httpClient["delete"](e+t).pipe(s.mergeMap(function(e){return n.useIndexDb?r._updateIndexDb(n,null,"DELETE").pipe(s.map(function(){return e})):c.of(e)})).pipe(s.catchError(r._handleError))}),s.catchError(this._handleError))},e.prototype._get=function(t,e){var r=this;return this._getSanitizedRootUrl(e).pipe(s.mergeMap(function(e){return r.httpClient.get(e+t).pipe(s.catchError(r._handleError))}),s.catchError(this._handleError))},e.prototype._handleError=function(e){var t=null;return t=e.error instanceof ErrorEvent?{message:e.error,status:e.status,statusText:e.statusText}:{message:e.error instanceof Object?e.error.message:e.error||e.message,status:e.status,statusText:e.statusText},c.throwError(t)},e.prototype._getSanitizedRootUrl=function(e){return e.useRootUrl?this.manifestService.getRootUrl():this._getApiRootUrl(e.includeVersionNumber,e.preferPreviousApiVersion)},e.prototype._getApiRootUrl=function(t,r){var e=this;return void 0===t&&(t=!1),void 0===r&&(r=!1),this.manifestService.getRootUrl().pipe(s.switchMap(function(t){return e.systemInfoService.getSystemVersion().pipe(s.map(function(e){return{rootUrl:t,version:e-1<=25?e+1:e}}))})).pipe(s.map(function(e){return e.rootUrl+"api/"+(t&&!r?e.version+"/":r&&e.version?e.version-1+"/":"")}))},e.prototype._updateIndexDb=function(e,t,r){void 0===r&&(r="CREATE");var n=e.indexDbConfig?e.indexDbConfig.schema:null,o=e.indexDbConfig?e.indexDbConfig.arrayKey:null,i=e.indexDbConfig?e.indexDbConfig.key:null,a=o?t[o]:t;switch(r){case"CREATE":case"UPDATE":return("CREATE"===r?this.indexDbService.post(n,a):this.indexDbService.put(n,a)).pipe(s.map(function(){return t}),s.catchError(function(e){return console.warn("Could not save data into index DB, ERROR: "+e),c.of(t)}));case"DELETE":return this.indexDbService["delete"](n,i).pipe(s.map(function(){return t}),s.catchError(function(e){return console.warn("Could not delete data from index DB, ERROR: "+e),c.of(t)}));default:return console.log("No action has been specified"),c.of(t)}},e.prototype._fetchFromIndexDb=function(n){var e=n.indexDbConfig?n.indexDbConfig.schema:null,t=n.indexDbConfig?n.indexDbConfig.key:null;return t?this.indexDbService.findOne(e,t):this.indexDbService.findAll(e).pipe(s.map(function(e){var t,r=n.indexDbConfig?n.indexDbConfig.arrayKey:null;return 0<e.length?r?((t={})[r]=e,t):e:null}))},e.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:r.HttpClient},{type:n},{type:o},{type:d}]},e.ngInjectableDef=t.defineInjectable({factory:function(){return new e(t.inject(r.HttpClient),t.inject(n),t.inject(o),t.inject(d))},token:e,providedIn:"root"}),e}();e.ManifestService=n,e.SystemInfoService=o,e.NgxDhis2HttpClientService=l,e.IndexDbService=d,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=iapps-ngx-dhis2-http-client.umd.min.js.map